/*
ACC Telemetry Music Engine for SuperCollider
èµ›è½¦é¥æµ‹æ•°æ®éŸ³ä¹ç”Ÿæˆå¼•æ“

è¿™ä¸ªSuperColliderè„šæœ¬æ¥æ”¶æ¥è‡ªACCé¥æµ‹ç³»ç»Ÿçš„OSCæ•°æ®ï¼Œ
å¹¶å°†å…¶è½¬æ¢ä¸ºå®æ—¶éŸ³ä¹ï¼Œå®ç°ç±»ä¼¼å¥”é©°MBUX Sound Driveçš„åŠŸèƒ½ã€‚

ä½¿ç”¨æ–¹æ³•ï¼š
1. å¯åŠ¨SuperCollider
2. è¿è¡Œæ­¤è„šæœ¬
3. å¯åŠ¨Pythonç«¯çš„SuperColliderEngine
4. å¼€å§‹é©¾é©¶ACCå¹¶äº«å—éŸ³ä¹åŒ–çš„é¥æµ‹ä½“éªŒ
*/

(
// ============================================================================
// å…¨å±€å˜é‡å’Œé…ç½®
// ============================================================================

// OSCæ¥æ”¶å™¨
~oscReceiver = nil;

// éŸ³é¢‘åˆæˆå™¨
~mainSynth = nil;
~rhythmSynth = nil;
~harmonySynth = nil;
~ambientSynth = nil;

// å½“å‰éŸ³ä¹å‚æ•°
~musicParams = (
    // èŠ‚å¥å‚æ•°
    bpm: 120,
    
    // éŸ³è°ƒå‚æ•°
    basePitch: 60,
    steeringInfluence: 0,
    gear: 1,
    
    // åŠ¨æ€å‚æ•°
    volume: 0.7,
    throttle: 0,
    brake: 0,
    
    // éŸ³è‰²å‚æ•°
    filterFreq: 1000,
    resonance: 0.3,
    
    // ç©ºé—´å‚æ•°
    pan: 0,
    reverb: 0.2,
    delay: 0.1
);

// åŸå§‹é¥æµ‹æ•°æ®
~rawData = (
    speed: 0,
    rpm: 0,
    gear: 1,
    throttle: 0,
    brake: 0,
    steer: 0
);

// ============================================================================
// éŸ³é¢‘åˆæˆå™¨å®šä¹‰
// ============================================================================

// ä¸»å¼•æ“å£°éŸ³åˆæˆå™¨
SynthDef(\accMainEngine, {
    |out=0, freq=110, amp=0.5, filterFreq=1000, resonance=0.3, pan=0|
    var sig, env, filter;
    
    // åŸºç¡€å¼•æ“å£°éŸ³ - ä½¿ç”¨é”¯é½¿æ³¢å’Œå™ªå£°æ··åˆ
    sig = Mix([
        Saw.ar(freq * [1, 1.01, 0.5], 0.3),
        PinkNoise.ar(0.1),
        SinOsc.ar(freq * 2, 0, 0.1)
    ]);
    
    // åŠ¨æ€åŒ…ç»œ
    env = EnvGen.kr(Env.asr(0.1, 1, 0.5), gate: 1);
    
    // æ»¤æ³¢å™¨å¤„ç†
    filter = RLPF.ar(sig, filterFreq, resonance);
    
    // è¾“å‡º
    Out.ar(out, Pan2.ar(filter * env * amp, pan));
}).add;

// èŠ‚å¥æ‰“å‡»ä¹åˆæˆå™¨
SynthDef(\accRhythm, {
    |out=0, freq=60, amp=0.3, decay=0.3, pan=0|
    var sig, env;
    
    // æ‰“å‡»ä¹å£°éŸ³
    sig = Mix([
        SinOsc.ar(freq, 0, 0.5),
        WhiteNoise.ar(0.1)
    ]);
    
    // å¿«é€Ÿè¡°å‡åŒ…ç»œ
    env = EnvGen.kr(Env.perc(0.01, decay), doneAction: 2);
    
    // è¾“å‡º
    Out.ar(out, Pan2.ar(sig * env * amp, pan));
}).add;

// å’Œå£°åˆæˆå™¨
SynthDef(\accHarmony, {
    |out=0, freq=220, amp=0.4, filterFreq=2000, pan=0|
    var sig, env, filter;
    
    // å’Œå£°å£°éŸ³ - ä½¿ç”¨å¤šä¸ªæ­£å¼¦æ³¢
    sig = Mix([
        SinOsc.ar(freq * [1, 1.25, 1.5, 2], 0, [0.3, 0.2, 0.15, 0.1])
    ]);
    
    // ç¼“æ…¢å˜åŒ–çš„åŒ…ç»œ
    env = EnvGen.kr(Env.asr(0.5, 1, 1), gate: 1);
    
    // ä½é€šæ»¤æ³¢
    filter = LPF.ar(sig, filterFreq);
    
    // è¾“å‡º
    Out.ar(out, Pan2.ar(filter * env * amp, pan));
}).add;

// ç¯å¢ƒéŸ³æ•ˆåˆæˆå™¨
SynthDef(\accAmbient, {
    |out=0, amp=0.2, reverb=0.2, delay=0.1, pan=0|
    var sig, delayed, reverbed;
    
    // ç¯å¢ƒå£°éŸ³ - ä½¿ç”¨æ»¤æ³¢å™ªå£°
    sig = BPF.ar(PinkNoise.ar(1), LFNoise1.kr(0.1).range(200, 2000), 0.1);
    
    // å»¶è¿Ÿæ•ˆæœ
    delayed = DelayL.ar(sig, 1, delay) * 0.3;
    
    // æ··å“æ•ˆæœ
    reverbed = FreeVerb.ar(sig + delayed, reverb, 0.8, 0.3);
    
    // è¾“å‡º
    Out.ar(out, Pan2.ar(reverbed * amp, pan));
}).add;

// ============================================================================
// OSCæ¶ˆæ¯å¤„ç†å‡½æ•°
// ============================================================================

// æ›´æ–°BPM
~updateBPM = { |bpm|
    ~musicParams.bpm = bpm;
    // æ›´æ–°èŠ‚å¥æ¨¡å¼çš„æ—¶é—´é—´éš”
    if (~rhythmPattern.notNil) {
        ~rhythmPattern.stop;
        ~startRhythmPattern.value;
    };
};

// æ›´æ–°éŸ³è°ƒå‚æ•°
~updatePitch = { |basePitch, steeringInfluence, gear|
    ~musicParams.basePitch = basePitch;
    ~musicParams.steeringInfluence = steeringInfluence;
    ~musicParams.gear = gear;
    
    // æ›´æ–°ä¸»åˆæˆå™¨é¢‘ç‡
    if (~mainSynth.notNil) {
        ~mainSynth.set(\freq, basePitch.midicps);
    };
    
    // æ›´æ–°å’Œå£°åˆæˆå™¨
    if (~harmonySynth.notNil) {
        ~harmonySynth.set(\freq, (basePitch + 7).midicps); // äº”åº¦å’Œå£°
    };
};

// æ›´æ–°åŠ¨æ€å‚æ•°
~updateDynamics = { |volume, throttle, brake|
    ~musicParams.volume = volume;
    ~musicParams.throttle = throttle;
    ~musicParams.brake = brake;
    
    // æ›´æ–°æ‰€æœ‰åˆæˆå™¨çš„éŸ³é‡
    if (~mainSynth.notNil) {
        ~mainSynth.set(\amp, volume * 0.5);
    };
    if (~harmonySynth.notNil) {
        ~harmonySynth.set(\amp, volume * 0.3);
    };
};

// æ›´æ–°éŸ³è‰²å‚æ•°
~updateTimbre = { |filterFreq, resonance|
    ~musicParams.filterFreq = filterFreq;
    ~musicParams.resonance = resonance;
    
    // æ›´æ–°æ»¤æ³¢å™¨å‚æ•°
    if (~mainSynth.notNil) {
        ~mainSynth.set(\filterFreq, filterFreq, \resonance, resonance);
    };
};

// æ›´æ–°ç©ºé—´å‚æ•°
~updateSpatial = { |pan, reverb, delay|
    ~musicParams.pan = pan;
    ~musicParams.reverb = reverb;
    ~musicParams.delay = delay;
    
    // æ›´æ–°æ‰€æœ‰åˆæˆå™¨çš„ç©ºé—´å‚æ•°
    if (~mainSynth.notNil) {
        ~mainSynth.set(\pan, pan);
    };
    if (~harmonySynth.notNil) {
        ~harmonySynth.set(\pan, pan);
    };
    if (~ambientSynth.notNil) {
        ~ambientSynth.set(\reverb, reverb, \delay, delay, \pan, pan);
    };
};

// ============================================================================
// èŠ‚å¥æ¨¡å¼æ§åˆ¶
// ============================================================================

~rhythmPattern = nil;

~startRhythmPattern = {
    var beatInterval;
    
    // è®¡ç®—èŠ‚æ‹é—´éš”
    beatInterval = 60.0 / ~musicParams.bpm;
    
    ~rhythmPattern = Routine({
        loop {
            // æ ¹æ®æ²¹é—¨å’Œåˆ¶åŠ¨åˆ›å»ºä¸åŒçš„èŠ‚å¥æ¨¡å¼
            var throttleIntensity = ~musicParams.throttle;
            var brakeIntensity = ~musicParams.brake;
            
            // ä¸»èŠ‚æ‹
            Synth(\accRhythm, [
                \freq, 60,
                \amp, 0.4 + (throttleIntensity * 0.3),
                \decay, 0.2 + (brakeIntensity * 0.3),
                \pan, ~musicParams.pan
            ]);
            
            beatInterval.wait;
            
            // å‰¯èŠ‚æ‹ï¼ˆæ ¹æ®è½¬é€Ÿæ·»åŠ ï¼‰
            if (~rawData.rpm > 3000) {
                (beatInterval * 0.5).wait;
                Synth(\accRhythm, [
                    \freq, 80,
                    \amp, 0.2,
                    \decay, 0.1,
                    \pan, ~musicParams.pan * -1
                ]);
                (beatInterval * 0.5).wait;
            } else {
                beatInterval.wait;
            };
        };
    }).play;
};

// ============================================================================
// ä¸»æ§åˆ¶å‡½æ•°
// ============================================================================

~startMusicEngine = {
    "å¯åŠ¨ACCéŸ³ä¹å¼•æ“...".postln;
    
    // å¯åŠ¨ä¸»åˆæˆå™¨
    ~mainSynth = Synth(\accMainEngine, [
        \freq, ~musicParams.basePitch.midicps,
        \amp, ~musicParams.volume * 0.5,
        \filterFreq, ~musicParams.filterFreq,
        \resonance, ~musicParams.resonance,
        \pan, ~musicParams.pan
    ]);
    
    // å¯åŠ¨å’Œå£°åˆæˆå™¨
    ~harmonySynth = Synth(\accHarmony, [
        \freq, (~musicParams.basePitch + 7).midicps,
        \amp, ~musicParams.volume * 0.3,
        \filterFreq, ~musicParams.filterFreq * 1.5,
        \pan, ~musicParams.pan
    ]);
    
    // å¯åŠ¨ç¯å¢ƒéŸ³æ•ˆ
    ~ambientSynth = Synth(\accAmbient, [
        \amp, 0.2,
        \reverb, ~musicParams.reverb,
        \delay, ~musicParams.delay,
        \pan, ~musicParams.pan
    ]);
    
    // å¯åŠ¨èŠ‚å¥æ¨¡å¼
    ~startRhythmPattern.value;
    
    "ACCéŸ³ä¹å¼•æ“å·²å¯åŠ¨ï¼".postln;
};

~stopMusicEngine = {
    "åœæ­¢ACCéŸ³ä¹å¼•æ“...".postln;
    
    // åœæ­¢æ‰€æœ‰åˆæˆå™¨
    if (~mainSynth.notNil) { ~mainSynth.free; ~mainSynth = nil; };
    if (~harmonySynth.notNil) { ~harmonySynth.free; ~harmonySynth = nil; };
    if (~ambientSynth.notNil) { ~ambientSynth.free; ~ambientSynth = nil; };
    
    // åœæ­¢èŠ‚å¥æ¨¡å¼
    if (~rhythmPattern.notNil) { ~rhythmPattern.stop; ~rhythmPattern = nil; };
    
    "ACCéŸ³ä¹å¼•æ“å·²åœæ­¢ï¼".postln;
};

// ============================================================================
// OSCæ¥æ”¶å™¨è®¾ç½®
// ============================================================================

~setupOSCReceiver = {
    "è®¾ç½®OSCæ¥æ”¶å™¨...".postln;
    
    // éŸ³ä¹å‚æ•°OSCæ¶ˆæ¯
    OSCdef(\accBPM, { |msg|
        ~updateBPM.value(msg[1]);
    }, '/acc/music/bpm');
    
    OSCdef(\accPitchBase, { |msg|
        ~updatePitch.value(msg[1], ~musicParams.steeringInfluence, ~musicParams.gear);
    }, '/acc/music/pitch/base');
    
    OSCdef(\accPitchSteering, { |msg|
        ~updatePitch.value(~musicParams.basePitch, msg[1], ~musicParams.gear);
    }, '/acc/music/pitch/steering');
    
    OSCdef(\accPitchGear, { |msg|
        ~updatePitch.value(~musicParams.basePitch, ~musicParams.steeringInfluence, msg[1]);
    }, '/acc/music/pitch/gear');
    
    OSCdef(\accVolume, { |msg|
        ~updateDynamics.value(msg[1], ~musicParams.throttle, ~musicParams.brake);
    }, '/acc/music/dynamics/volume');
    
    OSCdef(\accThrottle, { |msg|
        ~updateDynamics.value(~musicParams.volume, msg[1], ~musicParams.brake);
    }, '/acc/music/dynamics/throttle');
    
    OSCdef(\accBrake, { |msg|
        ~updateDynamics.value(~musicParams.volume, ~musicParams.throttle, msg[1]);
    }, '/acc/music/dynamics/brake');
    
    OSCdef(\accFilter, { |msg|
        ~updateTimbre.value(msg[1], ~musicParams.resonance);
    }, '/acc/music/timbre/filter');
    
    OSCdef(\accResonance, { |msg|
        ~updateTimbre.value(~musicParams.filterFreq, msg[1]);
    }, '/acc/music/timbre/resonance');
    
    OSCdef(\accPan, { |msg|
        ~updateSpatial.value(msg[1], ~musicParams.reverb, ~musicParams.delay);
    }, '/acc/music/spatial/pan');
    
    OSCdef(\accReverb, { |msg|
        ~updateSpatial.value(~musicParams.pan, msg[1], ~musicParams.delay);
    }, '/acc/music/spatial/reverb');
    
    OSCdef(\accDelay, { |msg|
        ~updateSpatial.value(~musicParams.pan, ~musicParams.reverb, msg[1]);
    }, '/acc/music/spatial/delay');
    
    // åŸå§‹é¥æµ‹æ•°æ®OSCæ¶ˆæ¯
    OSCdef(\accRawSpeed, { |msg|
        ~rawData.speed = msg[1];
    }, '/acc/raw/speed');
    
    OSCdef(\accRawRPM, { |msg|
        ~rawData.rpm = msg[1];
    }, '/acc/raw/rpm');
    
    OSCdef(\accRawGear, { |msg|
        ~rawData.gear = msg[1];
    }, '/acc/raw/gear');
    
    OSCdef(\accRawThrottle, { |msg|
        ~rawData.throttle = msg[1];
    }, '/acc/raw/throttle');
    
    OSCdef(\accRawBrake, { |msg|
        ~rawData.brake = msg[1];
    }, '/acc/raw/brake');
    
    OSCdef(\accRawSteer, { |msg|
        ~rawData.steer = msg[1];
    }, '/acc/raw/steer');
    
    "OSCæ¥æ”¶å™¨å·²è®¾ç½®å®Œæˆï¼ç›‘å¬ç«¯å£: 57120".postln;
};

// ============================================================================
// æ¸…ç†å‡½æ•°
// ============================================================================

~cleanup = {
    "æ¸…ç†ACCéŸ³ä¹å¼•æ“èµ„æº...".postln;
    
    // åœæ­¢éŸ³ä¹å¼•æ“
    ~stopMusicEngine.value;
    
    // æ¸…ç†OSCå®šä¹‰
    OSCdef.freeAll;
    
    "æ¸…ç†å®Œæˆï¼".postln;
};

// ============================================================================
// ç”¨æˆ·ç•Œé¢å’Œæ§åˆ¶
// ============================================================================

~showStatus = {
    "\n=== ACCéŸ³ä¹å¼•æ“çŠ¶æ€ ===".postln;
    "å½“å‰BPM: %".format(~musicParams.bpm).postln;
    "åŸºç¡€éŸ³è°ƒ: % (MIDI)".format(~musicParams.basePitch).postln;
    "éŸ³é‡: %".format(~musicParams.volume).postln;
    "æ»¤æ³¢é¢‘ç‡: % Hz".format(~musicParams.filterFreq).postln;
    "ç«‹ä½“å£°å¹³è¡¡: %".format(~musicParams.pan).postln;
    "\nåŸå§‹æ•°æ®:".postln;
    "é€Ÿåº¦: % km/h".format(~rawData.speed).postln;
    "è½¬é€Ÿ: % RPM".format(~rawData.rpm).postln;
    "æ¡£ä½: %".format(~rawData.gear).postln;
    "æ²¹é—¨: %".format(~rawData.throttle).postln;
    "åˆ¶åŠ¨: %".format(~rawData.brake).postln;
    "è½¬å‘: %".format(~rawData.steer).postln;
    "========================\n".postln;
};

// ============================================================================
// ä¸»ç¨‹åºå¯åŠ¨
// ============================================================================

"\nğŸµ ACC Telemetry Music Engine ğŸï¸".postln;
"====================================".postln;
"æ­£åœ¨åˆå§‹åŒ–...".postln;

// ç­‰å¾…æœåŠ¡å™¨å¯åŠ¨
Server.default.waitForBoot({
    // è®¾ç½®OSCæ¥æ”¶å™¨
    ~setupOSCReceiver.value;
    
    // å¯åŠ¨éŸ³ä¹å¼•æ“
    ~startMusicEngine.value;
    
    "\nğŸ‰ ACCéŸ³ä¹å¼•æ“å·²å°±ç»ªï¼".postln;
    "\nä½¿ç”¨è¯´æ˜:".postln;
    "1. å¯åŠ¨Pythonç«¯çš„SuperColliderEngine".postln;
    "2. è¿è¡ŒACCæ¸¸æˆ".postln;
    "3. äº«å—éŸ³ä¹åŒ–çš„é©¾é©¶ä½“éªŒï¼".postln;
    "\næ§åˆ¶å‘½ä»¤:".postln;
    "~showStatus.value;  // æ˜¾ç¤ºå½“å‰çŠ¶æ€".postln;
    "~stopMusicEngine.value;  // åœæ­¢éŸ³ä¹å¼•æ“".postln;
    "~startMusicEngine.value;  // é‡æ–°å¯åŠ¨éŸ³ä¹å¼•æ“".postln;
    "~cleanup.value;  // æ¸…ç†æ‰€æœ‰èµ„æº".postln;
    "\nå‡†å¤‡æ¥æ”¶é¥æµ‹æ•°æ®...".postln;
});

// æ³¨å†Œæ¸…ç†å‡½æ•°ï¼Œåœ¨é€€å‡ºæ—¶è‡ªåŠ¨è°ƒç”¨
CmdPeriod.doOnce({ ~cleanup.value; });

)

// ============================================================================
// ä½¿ç”¨ç¤ºä¾‹å’Œæµ‹è¯•ä»£ç 
// ============================================================================

/*
// æ‰‹åŠ¨æµ‹è¯•éŸ³ä¹å‚æ•°ï¼ˆåœ¨æ²¡æœ‰é¥æµ‹æ•°æ®æ—¶ä½¿ç”¨ï¼‰
(
// æµ‹è¯•BPMå˜åŒ–
fork {
    (60..180).do { |bpm|
        ~updateBPM.value(bpm);
        "BPM: %".format(bpm).postln;
        0.1.wait;
    };
};
)

// æµ‹è¯•éŸ³è°ƒå˜åŒ–
(
fork {
    (48..72).do { |pitch|
        ~updatePitch.value(pitch, 0, 1);
        "Pitch: %".format(pitch).postln;
        0.2.wait;
    };
};
)

// æµ‹è¯•è½¬å‘æ•ˆæœ
(
fork {
    100.do {
        var steering = sin(Date.getDate.rawSeconds * 2) * 0.5;
        ~updatePitch.value(60, steering, 1);
        ~updateSpatial.value(steering, 0.2, 0.1);
        0.05.wait;
    };
};
)
*/