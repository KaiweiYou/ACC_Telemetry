<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACC 遥测仪表盘</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            color: #ffffff;
            min-height: 100vh;
            padding: 15px;
            overflow-x: auto;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .connection-status {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .connection-status.connected {
            background-color: #4CAF50;
            color: white;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }

        .connection-status.disconnected {
            background-color: #f44336;
            color: white;
            box-shadow: 0 0 10px rgba(244, 67, 54, 0.5);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .gauge-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease;
        }

        .gauge-section:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }

        .section-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #FFD700;
            text-align: center;
            border-bottom: 2px solid #FFD700;
            padding-bottom: 8px;
        }

        .gauge-container {
             display: flex;
             justify-content: center;
             align-items: center;
             min-height: 200px;
         }

         /* 纯CSS仪表盘样式 */
         .custom-gauge {
             position: relative;
             width: 200px;
             height: 200px;
             border-radius: 50%;
             background: radial-gradient(circle, #1a1a1a 60%, #333 100%);
             border: 3px solid #FFD700;
             display: flex;
             align-items: center;
             justify-content: center;
             box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
         }

         .custom-gauge::before {
             content: '';
             position: absolute;
             top: 10px;
             left: 10px;
             right: 10px;
             bottom: 10px;
             border-radius: 50%;
             background: conic-gradient(
                 from 225deg,
                 #4ecdc4 0deg 135deg,
                 #ffa500 135deg 180deg,
                 #ff6b6b 180deg 225deg,
                 transparent 225deg 360deg
             );
             mask: radial-gradient(circle, transparent 70%, black 72%);
             -webkit-mask: radial-gradient(circle, transparent 70%, black 72%);
         }

         .gauge-content {
             position: relative;
             z-index: 10;
             text-align: center;
             color: white;
         }

         .gauge-value {
             font-size: 2.2em;
             font-weight: bold;
             color: #FFD700;
             text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
             font-family: 'Courier New', monospace;
         }

         .gauge-title {
             font-size: 0.9em;
             color: #FFD700;
             margin-top: 5px;
             text-transform: uppercase;
             letter-spacing: 1px;
         }

         .gauge-needle {
             position: absolute;
             top: 50%;
             left: 50%;
             width: 3px;
             height: 80px;
             background: linear-gradient(to top, #FFD700, #fff);
             transform-origin: bottom center;
             transform: translate(-50%, -100%) rotate(-135deg);
             transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
             border-radius: 2px;
             box-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
             z-index: 5;
         }

         .gauge-needle::after {
             content: '';
             position: absolute;
             bottom: -5px;
             left: 50%;
             transform: translateX(-50%);
             width: 10px;
             height: 10px;
             border-radius: 50%;
             background: #FFD700;
             box-shadow: 0 0 15px rgba(255, 215, 0, 0.8);
         }

         /* 小型仪表盘样式 */
         .mini-gauge {
             position: relative;
             width: 120px;
             height: 120px;
             border-radius: 50%;
             background: radial-gradient(circle, #1a1a1a 60%, #333 100%);
             border: 2px solid #4ecdc4;
             display: flex;
             align-items: center;
             justify-content: center;
             margin: 0 auto;
             box-shadow: 0 0 15px rgba(76, 205, 196, 0.3);
         }

         .mini-gauge::before {
             content: '';
             position: absolute;
             top: 8px;
             left: 8px;
             right: 8px;
             bottom: 8px;
             border-radius: 50%;
             background: conic-gradient(
                 from 225deg,
                 #4ecdc4 0deg 270deg,
                 transparent 270deg 360deg
             );
             mask: radial-gradient(circle, transparent 70%, black 72%);
             -webkit-mask: radial-gradient(circle, transparent 70%, black 72%);
         }

         .mini-gauge-content {
             position: relative;
             z-index: 10;
             text-align: center;
             color: white;
         }

         .mini-gauge-value {
             font-size: 1.4em;
             font-weight: bold;
             color: #4ecdc4;
             font-family: 'Courier New', monospace;
             text-shadow: 0 0 8px rgba(76, 205, 196, 0.5);
         }

         .mini-gauge-title {
             font-size: 0.7em;
             color: #4ecdc4;
             margin-top: 2px;
             text-transform: uppercase;
             letter-spacing: 1px;
         }

         .mini-gauge-needle {
             position: absolute;
             top: 50%;
             left: 50%;
             width: 2px;
             height: 50px;
             background: linear-gradient(to top, #4ecdc4, #fff);
             transform-origin: bottom center;
             transform: translate(-50%, -100%) rotate(-135deg);
             transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
             border-radius: 1px;
             box-shadow: 0 0 8px rgba(76, 205, 196, 0.8);
             z-index: 5;
         }

         .mini-gauge-needle::after {
             content: '';
             position: absolute;
             bottom: -4px;
             left: 50%;
             transform: translateX(-50%);
             width: 8px;
             height: 8px;
             border-radius: 50%;
             background: #4ecdc4;
             box-shadow: 0 0 12px rgba(76, 205, 196, 0.8);
         }

        .digital-display {
            text-align: center;
            padding: 20px;
        }

        .digital-value {
            font-size: 3em;
            font-weight: bold;
            color: #00ff88;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
            font-family: 'Courier New', monospace;
        }

        .digital-label {
            font-size: 1.1em;
            color: #B0C4DE;
            margin-top: 10px;
        }

        .bar-chart-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            padding: 10px;
        }

        .bar-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .bar-label {
            font-size: 0.9em;
            color: #B0C4DE;
            margin-bottom: 8px;
        }

        .bar-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 10px;
        }

        .bar-visual {
            height: 80px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }

        .bar-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, #4ecdc4, #45b7d1);
            transition: height 0.3s ease;
            border-radius: 4px;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            padding: 10px;
        }

        .status-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .status-item.active {
            background: rgba(76, 175, 80, 0.3);
            border: 1px solid #4CAF50;
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.3);
        }

        .status-label {
            font-size: 0.8em;
            color: #B0C4DE;
            margin-bottom: 5px;
        }

        .status-value {
            font-size: 1.1em;
            font-weight: bold;
            color: #ffffff;
        }

        .g-force-container {
            position: relative;
            width: 200px;
            height: 200px;
            margin: 0 auto;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .g-force-dot {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #ff6b6b;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.1s ease;
            box-shadow: 0 0 10px rgba(255, 107, 107, 0.7);
        }

        .g-force-labels {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .g-label {
            position: absolute;
            font-size: 0.8em;
            color: #B0C4DE;
            font-weight: bold;
        }

        .g-label.top { top: 5px; left: 50%; transform: translateX(-50%); }
        .g-label.bottom { bottom: 5px; left: 50%; transform: translateX(-50%); }
        .g-label.left { left: 5px; top: 50%; transform: translateY(-50%); }
        .g-label.right { right: 5px; top: 50%; transform: translateY(-50%); }

        .loading {
            text-align: center;
            font-size: 1.2em;
            color: #B0C4DE;
            margin-top: 50px;
        }

        .refresh-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #4CAF50;
            animation: pulse 1s infinite;
            z-index: 1000;
        }

        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.3; transform: scale(1.2); }
            100% { opacity: 1; transform: scale(1); }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .bar-chart-container {
                grid-template-columns: 1fr;
            }
            
            .status-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="refresh-indicator" id="refreshIndicator"></div>
    
    <div class="header">
        <h1>🏎️ ACC 专业遥测仪表盘</h1>
        <div class="connection-status disconnected" id="connectionStatus">连接中...</div>
    </div>

    <div class="dashboard-grid" id="dashboardContainer">
        <div class="loading">正在加载遥测数据...</div>
    </div>

    <script>
        class TelemetryDashboard {
            constructor() {
                this.socket = io();
                this.setupSocketEvents();
                this.createDashboard();
            }

            setupSocketEvents() {
                this.socket.on('connect', () => {
                    console.log('已连接到服务器');
                    this.updateConnectionStatus(true);
                });

                this.socket.on('disconnect', () => {
                    console.log('与服务器断开连接');
                    this.updateConnectionStatus(false);
                });

                this.socket.on('telemetry_update', (data) => {
                    this.updateTelemetryData(data);
                    this.flashRefreshIndicator();
                });
            }

            updateConnectionStatus(connected) {
                const statusElement = document.getElementById('connectionStatus');
                if (connected) {
                    statusElement.textContent = '已连接';
                    statusElement.className = 'connection-status connected';
                } else {
                    statusElement.textContent = '连接断开';
                    statusElement.className = 'connection-status disconnected';
                }
            }

            flashRefreshIndicator() {
                const indicator = document.getElementById('refreshIndicator');
                indicator.style.backgroundColor = '#FFD700';
                setTimeout(() => {
                    indicator.style.backgroundColor = '#4CAF50';
                }, 100);
            }



            async createDashboard() {
                try {
                    // 获取配置数据
                    const response = await fetch('/api/config');
                    this.config = await response.json();
                    
                    const container = document.getElementById('dashboardContainer');
                    container.innerHTML = '';

                    // 根据配置动态创建仪表盘组件
                    this.createDynamicDashboard(container);
                } catch (error) {
                    console.error('加载配置失败:', error);
                    // 如果配置加载失败，创建默认仪表盘
                    const container = document.getElementById('dashboardContainer');
                    container.innerHTML = '';
                    this.createDefaultDashboard(container);
                }
            }

            createDynamicDashboard(container) {
                const settings = this.config.display_settings;
                const dataConfig = this.config.data_config;

                // 主要仪表盘（RPM和速度）
                if (settings.rpm || settings.speed) {
                    this.createMainGauges(container, settings);
                }

                // 档位显示
                if (settings.gear) {
                    this.createGearDisplay(container, settings);
                }

                // 踏板数据
                if (settings.throttle || settings.brake || settings.clutch) {
                    this.createPedalGauges(container, settings);
                }

                // 轮胎压力
                if (settings.tire_pressure_fl || settings.tire_pressure_fr || 
                    settings.tire_pressure_rl || settings.tire_pressure_rr) {
                    this.createTirePressureBars(container, settings);
                }

                // 轮胎温度
                if (settings.tire_temp_fl || settings.tire_temp_fr || 
                    settings.tire_temp_rl || settings.tire_temp_rr) {
                    this.createTireTemperatureBars(container, settings);
                }

                // 刹车温度
                if (settings.brake_temp_fl || settings.brake_temp_fr || 
                    settings.brake_temp_rl || settings.brake_temp_rr) {
                    this.createBrakeTemperatureBars(container, settings);
                }

                // G力显示
                if (settings.acceleration_x || settings.acceleration_y) {
                    this.createGForceDisplay(container, settings);
                }

                // 引擎数据
                if (settings.water_temp || settings.fuel) {
                    this.createEngineGauges(container, settings);
                }

                // 系统状态
                if (settings.abs_active || settings.tc_active) {
                    this.createSystemStatus(container, settings);
                }

                // 圈速数据
                if (settings.lap_time || settings.best_lap) {
                    this.createLapTimeDisplay(container, settings);
                }
            }

            createDefaultDashboard(container) {
                // 默认仪表盘（当配置加载失败时使用）
                this.createMainGauges(container, {rpm: true, speed: true});
                this.createGearDisplay(container);
                this.createPedalGauges(container, {throttle: true, brake: true, clutch: true});
            }

            createMainGauges(container, settings = {}) {
                const section = this.createSection('主要仪表', container);
                const gaugeContainer = document.createElement('div');
                gaugeContainer.style.display = 'grid';
                gaugeContainer.style.gridTemplateColumns = 'repeat(auto-fit, minmax(200px, 1fr))';
                gaugeContainer.style.gap = '20px';
                section.appendChild(gaugeContainer);

                // 转速表
                if (settings.rpm) {
                    const rpmContainer = document.createElement('div');
                    rpmContainer.className = 'gauge-container';
                    rpmContainer.innerHTML = `
                        <div class="custom-gauge" id="rpm-gauge">
                            <div class="gauge-needle" id="rpm-needle"></div>
                            <div class="gauge-content">
                                <div class="gauge-value" id="rpm-value">0</div>
                                <div class="gauge-title">RPM</div>
                            </div>
                        </div>
                    `;
                    gaugeContainer.appendChild(rpmContainer);
                }

                // 车速表
                if (settings.speed) {
                    const speedContainer = document.createElement('div');
                    speedContainer.className = 'gauge-container';
                    speedContainer.innerHTML = `
                        <div class="custom-gauge" id="speed-gauge">
                            <div class="gauge-needle" id="speed-needle"></div>
                            <div class="gauge-content">
                                <div class="gauge-value" id="speed-value">0</div>
                                <div class="gauge-title">KM/H</div>
                            </div>
                        </div>
                    `;
                    gaugeContainer.appendChild(speedContainer);
                }
            }

            createGearDisplay(container, settings = {}) {
                if (settings.gear) {
                    const section = this.createSection('档位', container);
                    const display = document.createElement('div');
                    display.className = 'digital-display';
                    display.innerHTML = `
                        <div class="digital-value" id="gear-value">N</div>
                        <div class="digital-label">当前档位</div>
                    `;
                    section.appendChild(display);
                }
            }

            createTireData(container, settings = {}) {
                const hasTirePressure = settings.tire_pressure_fl || settings.tire_pressure_fr || 
                                       settings.tire_pressure_rl || settings.tire_pressure_rr;
                const hasTireTemp = settings.tire_temp_fl || settings.tire_temp_fr || 
                                   settings.tire_temp_rl || settings.tire_temp_rr;
                
                if (hasTirePressure || hasTireTemp) {
                    const section = this.createSection('轮胎数据', container);
                    const tireContainer = document.createElement('div');
                    tireContainer.className = 'tire-container';
                    
                    let tireHTML = '<div class="tire-grid">';
                    const tirePositions = [
                        { id: 'fl', label: '前左', pressure: 'tire_pressure_fl', temp: 'tire_temp_fl' },
                        { id: 'fr', label: '前右', pressure: 'tire_pressure_fr', temp: 'tire_temp_fr' },
                        { id: 'rl', label: '后左', pressure: 'tire_pressure_rl', temp: 'tire_temp_rl' },
                        { id: 'rr', label: '后右', pressure: 'tire_pressure_rr', temp: 'tire_temp_rr' }
                    ];
                    
                    tirePositions.forEach(tire => {
                        tireHTML += `
                            <div class="tire-item">
                                <div class="tire-label">${tire.label}</div>
                        `;
                        
                        if (settings[tire.pressure]) {
                            tireHTML += `<div class="tire-pressure" id="tire-pressure-${tire.id}">0.0 bar</div>`;
                        }
                        
                        if (settings[tire.temp]) {
                            tireHTML += `<div class="tire-temp" id="tire-temp-${tire.id}">0°C</div>`;
                        }
                        
                        tireHTML += '</div>';
                    });
                    
                    tireHTML += '</div>';
                    tireContainer.innerHTML = tireHTML;
                    section.appendChild(tireContainer);
                }
            }

            createPedalGauges(container, settings = {}) {
                if (settings.throttle || settings.brake || settings.clutch) {
                    const section = this.createSection('踏板数据', container);
                    const pedalContainer = document.createElement('div');
                    pedalContainer.style.display = 'grid';
                    
                    // 动态计算列数
                    const pedalCount = [settings.throttle, settings.brake, settings.clutch].filter(Boolean).length;
                    pedalContainer.style.gridTemplateColumns = `repeat(${pedalCount}, 1fr)`;
                    pedalContainer.style.gap = '10px';
                    section.appendChild(pedalContainer);

                    // 油门
                    if (settings.throttle) {
                        const throttleDiv = document.createElement('div');
                        throttleDiv.innerHTML = `
                            <div class="mini-gauge">
                                <div class="mini-gauge-needle" id="throttle-needle"></div>
                                <div class="mini-gauge-content">
                                    <div class="mini-gauge-value" id="throttle-value">0</div>
                                    <div class="mini-gauge-title">油门 %</div>
                                </div>
                            </div>
                        `;
                        pedalContainer.appendChild(throttleDiv);
                    }

                    // 刹车
                    if (settings.brake) {
                        const brakeDiv = document.createElement('div');
                        brakeDiv.innerHTML = `
                            <div class="mini-gauge">
                                <div class="mini-gauge-needle" id="brake-needle"></div>
                                <div class="mini-gauge-content">
                                    <div class="mini-gauge-value" id="brake-value">0</div>
                                    <div class="mini-gauge-title">刹车 %</div>
                                </div>
                            </div>
                        `;
                        pedalContainer.appendChild(brakeDiv);
                    }

                    // 离合
                    if (settings.clutch) {
                        const clutchDiv = document.createElement('div');
                        clutchDiv.innerHTML = `
                            <div class="mini-gauge">
                                <div class="mini-gauge-needle" id="clutch-needle"></div>
                                <div class="mini-gauge-content">
                                    <div class="mini-gauge-value" id="clutch-value">0</div>
                                    <div class="mini-gauge-title">离合 %</div>
                                </div>
                            </div>
                        `;
                        pedalContainer.appendChild(clutchDiv);
                    }
                }
            }

            createTirePressureBars(container, settings = {}) {
                const positions = [
                    {id: 'tire_pressure_fl', label: '左前'},
                    {id: 'tire_pressure_fr', label: '右前'},
                    {id: 'tire_pressure_rl', label: '左后'},
                    {id: 'tire_pressure_rr', label: '右后'}
                ];
                
                // 只显示配置为true的轮胎压力
                const enabledPositions = positions.filter(pos => settings[pos.id]);
                
                if (enabledPositions.length > 0) {
                    const section = this.createSection('轮胎压力', container);
                    const barsContainer = document.createElement('div');
                    barsContainer.className = 'bar-chart-container';
                    section.appendChild(barsContainer);

                    enabledPositions.forEach(pos => {
                        const barItem = document.createElement('div');
                        barItem.className = 'bar-item';
                        barItem.innerHTML = `
                            <div class="bar-label">${pos.label}</div>
                            <div class="bar-value" id="${pos.id}-value">0.0</div>
                            <div class="bar-visual">
                                <div class="bar-fill" id="${pos.id}-bar"></div>
                            </div>
                        `;
                        barsContainer.appendChild(barItem);
                    });
                }
            }

            createTireTemperatureBars(container, settings = {}) {
                const positions = [
                    {id: 'tire_temp_fl', label: '左前'},
                    {id: 'tire_temp_fr', label: '右前'},
                    {id: 'tire_temp_rl', label: '左后'},
                    {id: 'tire_temp_rr', label: '右后'}
                ];
                
                // 只显示配置为true的轮胎温度
                const enabledPositions = positions.filter(pos => settings[pos.id]);
                
                if (enabledPositions.length > 0) {
                    const section = this.createSection('轮胎温度', container);
                    const barsContainer = document.createElement('div');
                    barsContainer.className = 'bar-chart-container';
                    section.appendChild(barsContainer);

                    enabledPositions.forEach(pos => {
                        const barItem = document.createElement('div');
                        barItem.className = 'bar-item';
                        barItem.innerHTML = `
                            <div class="bar-label">${pos.label}</div>
                            <div class="bar-value" id="${pos.id}-value">0°C</div>
                            <div class="bar-visual">
                                <div class="bar-fill" id="${pos.id}-bar" style="background: linear-gradient(to top, #4ecdc4, #ffa500, #ff6b6b);"></div>
                            </div>
                        `;
                        barsContainer.appendChild(barItem);
                    });
                }
            }

            createBrakeTemperatureBars(container, settings = {}) {
                const positions = [
                    {id: 'brake_temp_fl', label: '左前'},
                    {id: 'brake_temp_fr', label: '右前'},
                    {id: 'brake_temp_rl', label: '左后'},
                    {id: 'brake_temp_rr', label: '右后'}
                ];
                
                // 只显示配置为true的刹车温度
                const enabledPositions = positions.filter(pos => settings[pos.id]);
                
                if (enabledPositions.length > 0) {
                    const section = this.createSection('刹车温度', container);
                    const barsContainer = document.createElement('div');
                    barsContainer.className = 'bar-chart-container';
                    section.appendChild(barsContainer);

                    enabledPositions.forEach(pos => {
                        const barItem = document.createElement('div');
                        barItem.className = 'bar-item';
                        barItem.innerHTML = `
                            <div class="bar-label">${pos.label}</div>
                            <div class="bar-value" id="${pos.id}-value">0°C</div>
                            <div class="bar-visual">
                                <div class="bar-fill" id="${pos.id}-bar" style="background: linear-gradient(to top, #4ecdc4, #ffa500, #ff6b6b);"></div>
                            </div>
                        `;
                        barsContainer.appendChild(barItem);
                    });
                }
            }

            createGForceDisplay(container, settings = {}) {
                if (settings.acceleration_x || settings.acceleration_y) {
                    const section = this.createSection('G力显示', container);
                    const gForceContainer = document.createElement('div');
                    gForceContainer.innerHTML = `
                        <div class="g-force-container">
                            <div class="g-force-dot" id="g-force-dot"></div>
                            <div class="g-force-labels">
                                <div class="g-label top">前进</div>
                                <div class="g-label bottom">制动</div>
                                <div class="g-label left">左转</div>
                                <div class="g-label right">右转</div>
                            </div>
                        </div>
                        <div style="text-align: center; margin-top: 15px;">
                            ${settings.acceleration_x ? '<div style="color: #B0C4DE; font-size: 0.9em;">横向: <span id="g-x-value">0.00</span>G</div>' : ''}
                            ${settings.acceleration_y ? '<div style="color: #B0C4DE; font-size: 0.9em;">纵向: <span id="g-y-value">0.00</span>G</div>' : ''}
                        </div>
                    `;
                    section.appendChild(gForceContainer);
                }
            }

            createEngineGauges(container, settings = {}) {
                if (settings.water_temp || settings.fuel) {
                    const section = this.createSection('引擎数据', container);
                    const engineContainer = document.createElement('div');
                    engineContainer.style.display = 'grid';
                    
                    // 动态计算列数
                    const engineCount = [settings.water_temp, settings.fuel].filter(Boolean).length;
                    engineContainer.style.gridTemplateColumns = `repeat(${engineCount}, 1fr)`;
                    engineContainer.style.gap = '15px';
                    section.appendChild(engineContainer);

                    // 水温
                    if (settings.water_temp) {
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = `
                            <div class="mini-gauge">
                                <div class="mini-gauge-needle" id="engine-temp-needle"></div>
                                <div class="mini-gauge-content">
                                    <div class="mini-gauge-value" id="engine-temp-value">0</div>
                                    <div class="mini-gauge-title">水温 °C</div>
                                </div>
                            </div>
                        `;
                        engineContainer.appendChild(tempDiv);
                    }

                    // 燃油
                    if (settings.fuel) {
                        const fuelDiv = document.createElement('div');
                        fuelDiv.innerHTML = `
                            <div class="mini-gauge">
                                <div class="mini-gauge-needle" id="fuel-needle"></div>
                                <div class="mini-gauge-content">
                                    <div class="mini-gauge-value" id="fuel-value">0</div>
                                    <div class="mini-gauge-title">燃油 L</div>
                                </div>
                            </div>
                        `;
                        engineContainer.appendChild(fuelDiv);
                    }
                }
            }

            createSystemStatus(container, settings = {}) {
                if (settings.abs_active || settings.tc_active) {
                    const section = this.createSection('辅助系统', container);
                    const statusContainer = document.createElement('div');
                    statusContainer.className = 'status-grid';
                    
                    let statusHTML = '';
                    
                    if (settings.tc_active) {
                        statusHTML += `
                            <div class="status-item" id="tc-status">
                                <div class="status-label">牵引力控制</div>
                                <div class="status-value" id="tc-value">关闭</div>
                            </div>
                        `;
                    }
                    
                    if (settings.abs_active) {
                        statusHTML += `
                            <div class="status-item" id="abs-status">
                                <div class="status-label">ABS</div>
                                <div class="status-value" id="abs-value">关闭</div>
                            </div>
                        `;
                    }
                    
                    statusContainer.innerHTML = statusHTML;
                     section.appendChild(statusContainer);
                }
            }

            createLapTimeDisplay(container, settings = {}) {
                if (settings.lap_time || settings.last_lap || settings.best_lap) {
                    const section = this.createSection('圈速数据', container);
                    const lapContainer = document.createElement('div');
                    lapContainer.style.display = 'grid';
                    lapContainer.style.gridTemplateColumns = '1fr';
                    lapContainer.style.gap = '15px';
                    lapContainer.style.textAlign = 'center';
                    
                    let lapHTML = '';
                    
                    if (settings.lap_time) {
                        lapHTML += `
                            <div>
                                <div style="color: #B0C4DE; font-size: 0.9em; margin-bottom: 5px;">当前圈时间</div>
                                <div style="font-size: 1.8em; font-weight: bold; color: #00ff88; font-family: 'Courier New', monospace;" id="lap-time-value">--:---.---</div>
                            </div>
                        `;
                    }
                    
                    if (settings.last_lap) {
                        lapHTML += `
                            <div>
                                <div style="color: #B0C4DE; font-size: 0.9em; margin-bottom: 5px;">上一圈时间</div>
                                <div style="font-size: 1.5em; font-weight: bold; color: #4ecdc4; font-family: 'Courier New', monospace;" id="last-lap-value">--:---.---</div>
                            </div>
                        `;
                    }
                    
                    if (settings.best_lap) {
                        lapHTML += `
                            <div>
                                <div style="color: #B0C4DE; font-size: 0.9em; margin-bottom: 5px;">最佳圈时间</div>
                                <div style="font-size: 1.5em; font-weight: bold; color: #FFD700; font-family: 'Courier New', monospace;" id="best-lap-value">--:---.---</div>
                            </div>
                        `;
                    }
                    
                    lapContainer.innerHTML = lapHTML;
                    section.appendChild(lapContainer);
                }
            }

            createSection(title, container) {
                const section = document.createElement('div');
                section.className = 'gauge-section';
                
                const titleElement = document.createElement('div');
                titleElement.className = 'section-title';
                titleElement.textContent = title;
                section.appendChild(titleElement);
                
                container.appendChild(section);
                return section;
            }

            updateTelemetryData(data) {
                // 更新主要仪表盘
                if (data.rpm !== undefined) {
                    const rpmValue = parseFloat(data.rpm) || 0;
                    const rpmElement = document.getElementById('rpm-value');
                    const rpmNeedle = document.getElementById('rpm-needle');
                    if (rpmElement && rpmNeedle) {
                        rpmElement.textContent = Math.round(rpmValue);
                        const angle = (rpmValue / 8000) * 270 - 135; // 假设最大8000 RPM
                        rpmNeedle.style.transform = `translate(-50%, -100%) rotate(${angle}deg)`;
                    }
                }
                if (data.speed !== undefined) {
                    const speedValue = parseFloat(data.speed) || 0;
                    const speedElement = document.getElementById('speed-value');
                    const speedNeedle = document.getElementById('speed-needle');
                    if (speedElement && speedNeedle) {
                        speedElement.textContent = Math.round(speedValue);
                        const angle = (speedValue / 300) * 270 - 135; // 假设最大300 KM/H
                        speedNeedle.style.transform = `translate(-50%, -100%) rotate(${angle}deg)`;
                    }
                }
                
                // 更新踏板数据
                if (data.throttle !== undefined) {
                    const throttleValue = parseFloat(data.throttle.replace('%', '')) || 0;
                    const throttleElement = document.getElementById('throttle-value');
                    const throttleNeedle = document.getElementById('throttle-needle');
                    if (throttleElement && throttleNeedle) {
                        throttleElement.textContent = Math.round(throttleValue);
                        const angle = (throttleValue / 100) * 270 - 135;
                        throttleNeedle.style.transform = `translate(-50%, -100%) rotate(${angle}deg)`;
                    }
                }
                if (data.brake !== undefined) {
                    const brakeValue = parseFloat(data.brake.replace('%', '')) || 0;
                    const brakeElement = document.getElementById('brake-value');
                    const brakeNeedle = document.getElementById('brake-needle');
                    if (brakeElement && brakeNeedle) {
                        brakeElement.textContent = Math.round(brakeValue);
                        const angle = (brakeValue / 100) * 270 - 135;
                        brakeNeedle.style.transform = `translate(-50%, -100%) rotate(${angle}deg)`;
                    }
                }
                if (data.clutch !== undefined) {
                    const clutchValue = parseFloat(data.clutch.replace('%', '')) || 0;
                    const clutchElement = document.getElementById('clutch-value');
                    const clutchNeedle = document.getElementById('clutch-needle');
                    if (clutchElement && clutchNeedle) {
                        clutchElement.textContent = Math.round(clutchValue);
                        const angle = (clutchValue / 100) * 270 - 135;
                        clutchNeedle.style.transform = `translate(-50%, -100%) rotate(${angle}deg)`;
                    }
                }
                
                // 更新引擎数据
                if (data.engine_temp !== undefined) {
                    const tempValue = parseFloat(data.engine_temp) || 0;
                    const tempElement = document.getElementById('engine-temp-value');
                    const tempNeedle = document.getElementById('engine-temp-needle');
                    if (tempElement && tempNeedle) {
                        tempElement.textContent = Math.round(tempValue);
                        const angle = (tempValue / 120) * 270 - 135; // 假设最大120°C
                        tempNeedle.style.transform = `translate(-50%, -100%) rotate(${angle}deg)`;
                    }
                }
                if (data.fuel !== undefined) {
                    const fuelValue = parseFloat(data.fuel) || 0;
                    const fuelElement = document.getElementById('fuel-value');
                    const fuelNeedle = document.getElementById('fuel-needle');
                    if (fuelElement && fuelNeedle) {
                        fuelElement.textContent = Math.round(fuelValue);
                        const angle = (fuelValue / 120) * 270 - 135; // 假设最大120L
                        fuelNeedle.style.transform = `translate(-50%, -100%) rotate(${angle}deg)`;
                    }
                }

                // 更新档位显示
                if (data.gear !== undefined) {
                    const gearElement = document.getElementById('gear-value');
                    if (gearElement) {
                        gearElement.textContent = data.gear;
                        // 根据档位改变颜色
                        if (data.gear === 'R') {
                            gearElement.style.color = '#ff6b6b';
                        } else if (data.gear === 'N') {
                            gearElement.style.color = '#ffa500';
                        } else {
                            gearElement.style.color = '#00ff88';
                        }
                    }
                }

                // 更新轮胎压力柱状图
                const tirePressures = ['tire_pressure_fl', 'tire_pressure_fr', 'tire_pressure_rl', 'tire_pressure_rr'];
                tirePressures.forEach(tire => {
                    if (data[tire] !== undefined) {
                        const value = parseFloat(data[tire]) || 0;
                        const valueElement = document.getElementById(`${tire}-value`);
                        const barElement = document.getElementById(`${tire}-bar`);
                        if (valueElement && barElement) {
                            valueElement.textContent = `${value.toFixed(1)} PSI`;
                            const percentage = Math.min((value / 35) * 100, 100); // 假设最大35 PSI
                            barElement.style.height = `${percentage}%`;
                        }
                    }
                });

                // 更新轮胎温度柱状图
                const tireTemps = ['tire_temp_fl', 'tire_temp_fr', 'tire_temp_rl', 'tire_temp_rr'];
                tireTemps.forEach(tire => {
                    if (data[tire] !== undefined) {
                        const value = parseFloat(data[tire]) || 0;
                        const valueElement = document.getElementById(`${tire}-value`);
                        const barElement = document.getElementById(`${tire}-bar`);
                        if (valueElement && barElement) {
                            valueElement.textContent = `${value.toFixed(0)}°C`;
                            const percentage = Math.min((value / 120) * 100, 100); // 假设最大120°C
                            barElement.style.height = `${percentage}%`;
                        }
                    }
                });

                // 更新刹车温度柱状图
                const brakeTemps = ['brake_temp_fl', 'brake_temp_fr', 'brake_temp_rl', 'brake_temp_rr'];
                brakeTemps.forEach(brake => {
                    if (data[brake] !== undefined) {
                        const value = parseFloat(data[brake]) || 0;
                        const valueElement = document.getElementById(`${brake}-value`);
                        const barElement = document.getElementById(`${brake}-bar`);
                        if (valueElement && barElement) {
                            valueElement.textContent = `${value.toFixed(0)}°C`;
                            const percentage = Math.min((value / 800) * 100, 100); // 假设最大800°C
                            barElement.style.height = `${percentage}%`;
                        }
                    }
                });

                // 更新G力显示
                if (data.acceleration_x !== undefined && data.acceleration_y !== undefined) {
                    const gxValue = parseFloat(data.acceleration_x) || 0;
                    const gyValue = parseFloat(data.acceleration_y) || 0;
                    
                    const gxElement = document.getElementById('g-x-value');
                    const gyElement = document.getElementById('g-y-value');
                    const dotElement = document.getElementById('g-force-dot');
                    
                    if (gxElement && gyElement && dotElement) {
                        gxElement.textContent = gxValue.toFixed(2);
                        gyElement.textContent = gyValue.toFixed(2);
                        
                        // 移动G力点（限制在圆形范围内）
                        const maxG = 2.0; // 最大G力范围
                        const radius = 90; // 圆形半径
                        const x = Math.max(-maxG, Math.min(maxG, gxValue)) / maxG * radius;
                        const y = Math.max(-maxG, Math.min(maxG, -gyValue)) / maxG * radius; // Y轴反向
                        
                        dotElement.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`;
                    }
                }

                // 更新辅助系统状态
                const systems = ['drs', 'tc', 'abs'];
                systems.forEach(system => {
                    if (data[system] !== undefined) {
                        const statusElement = document.getElementById(`${system}-status`);
                        const valueElement = document.getElementById(`${system}-value`);
                        if (statusElement && valueElement) {
                            valueElement.textContent = data[system];
                            if (data[system] === '开启') {
                                statusElement.classList.add('active');
                            } else {
                                statusElement.classList.remove('active');
                            }
                        }
                    }
                });

                // 更新圈速数据
                const lapTimes = ['lap_time', 'last_lap', 'best_lap'];
                lapTimes.forEach(lapTime => {
                    if (data[lapTime] !== undefined) {
                        const element = document.getElementById(`${lapTime.replace('_', '-')}-value`);
                        if (element) {
                            element.textContent = data[lapTime];
                        }
                    }
                });
            }
        }

        // 初始化仪表盘
        document.addEventListener('DOMContentLoaded', () => {
            new TelemetryDashboard();
        });
    </script>
</body>
</html>